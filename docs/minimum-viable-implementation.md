# 最小実装（MVP）仕様

## 目的

**自社サイトの記事で効果を実感する**ことを最優先に、最小限の機能で実装する。

## 前提条件

- **GSC連携は必須**（自社サイトの順位データを取得するため）
- まずは自社サイトで効果を実感したい
- フロントエンドは最小限（バックエンドロジックに集中）

## 最小実装の範囲

### ✅ 実装すべき機能（必須）

#### 1. GSC連携（OAuth 2.0）
- **目的**: 自社サイトの順位データを取得
- **実装内容**:
  - Google Cloud Consoleでアプリ作成
  - OAuth 2.0認証フロー（NextAuth.js推奨）
  - GSC APIとの連携
  - スコープ: `https://www.googleapis.com/auth/webmasters.readonly`
- **成果物**: 
  - OAuth認証機能
  - GSC API連携機能

#### 2. 順位データの取得と下落検知
- **目的**: 順位下落を自動検知
- **実装内容**:
  - GSC APIから特定記事の時系列データを取得
  - キーワード（クエリ）ごとの順位データを取得
  - **デフォルト設定**:
    - 過去7日間の平均順位と現在の平均順位を比較
    - 急落の判定：平均順位が2位以上下落、または特定キーワードが10位以下に転落
  - **注意**: MVPではデフォルト設定で動作。将来的にユーザーがカスタマイズ可能にする（後述）
- **成果物**: 
  - 順位データ取得機能
  - 急落検知ロジック（デフォルト設定）

#### 3. 競合URLの取得（ブラウジングツール）
- **目的**: 下落したキーワードで競合記事を取得
- **実装内容**:
  - 下落したキーワードでGoogle検索を実行（Playwright/Puppeteer）
  - 検索結果から自社URLより上位のサイトURLを抽出（上位3サイト）
  - CAPTCHA対応（リトライ機能、ユーザーエージェントローテーション）
- **成果物**: 
  - ブラウジングツールでの検索機能
  - 競合URL抽出機能

#### 4. 競合記事のスクレイピング
- **目的**: 競合記事の内容を取得
- **実装内容**:
  - Beautiful Soup/cheerioでHTMLパース
  - 必要に応じてPlaywrightでJavaScriptレンダリング
  - テキスト抽出
- **成果物**: 
  - スクレイピング機能
  - テキスト抽出機能

#### 5. 差分分析とリライト案生成（Gemini 2.5 Flash）
- **目的**: 競合との差分を分析し、追加すべき項目を提示
- **実装内容**:
  - 自社記事と競合記事（上位3サイト）を比較
  - 欠落している要素を特定
  - 箇条書き形式で追加すべき項目を生成
  - 形式: 「この情報が競合と比べて抜けているので、この観点でのこの項目を追加しろ」
- **成果物**: 
  - 差分分析機能
  - リライト案生成機能

#### 6. 通知機能（メール/Slack/LINE）
- **目的**: 順位下落とリライト案を通知
- **実装内容**:
  - メール通知（必須）
  - Slack通知（オプション）
  - LINE通知（オプション）
  - 通知内容: 順位下落の詳細 + 追加すべき項目の箇条書き
- **成果物**: 
  - メール送信機能
  - Slack/LINE通知機能（オプション）

#### 7. 定期実行（Cron）
- **目的**: 毎日順位をチェック
- **実装内容**:
  - Vercel CronまたはCloud Schedulerで定期実行
  - 毎日1回、前日のデータを取得（GSCデータは1-2日遅れで反映）
- **成果物**: 
  - 定期実行スクリプト

### ❌ 実装不要（後回し）

- **フロントエンド（ダッシュボード）**: 最小限でOK（通知で完結）
- **手動スキャン機能**: 後回し（自動通知に集中）
- **デモモード**: 後回し
- **無料お試し画面**: 後回し
- **有料プラン機能**: 後回し
- **WordPress連携**: 後回し

## 実装の流れ

### Step 1: GSC連携と順位データ取得（1-2日）
1. Google Cloud Consoleでアプリ作成
2. OAuth 2.0認証の実装
3. GSC APIから順位データを取得するスクリプト
4. テスト: 自社サイトの順位データが取得できることを確認

### Step 2: 順位下落検知ロジック（1日）
1. 過去7日間の平均順位と現在の平均順位を比較
2. 急落の判定ロジック
3. キーワードごとの分析
4. テスト: 急落が正しく検知されることを確認

### Step 3: 競合URL取得（ブラウジングツール）（2-3日）
1. Playwright/Puppeteerのセットアップ
2. Google検索の実行
3. 検索結果のパース
4. 自社URLより上位のサイトURLを抽出
5. CAPTCHA対応
6. テスト: 競合URLが正しく取得できることを確認

### Step 4: 競合記事スクレイピング（1-2日）
1. Beautiful Soup/cheerioのセットアップ
2. HTMLパースとテキスト抽出
3. テスト: 競合記事のテキストが正しく抽出できることを確認

### Step 5: 差分分析とリライト案生成（2-3日）
1. Gemini 2.5 Flash APIの連携
2. 自社記事と競合記事の比較ロジック
3. 箇条書き形式のリライト案生成
4. テスト: リライト案が正しく生成されることを確認

### Step 6: 通知機能（1-2日）
1. メール送信機能（SendGrid、Resend等）
2. 通知内容のフォーマット
3. テスト: 通知が正しく送信されることを確認

### Step 7: 定期実行（Cron）（1日）
1. Vercel CronまたはCloud Schedulerの設定
2. 定期実行スクリプト
3. テスト: 定期実行が正しく動作することを確認

## 技術スタック

詳細は [技術スタック](./technical-stack.md) を参照。

**最小実装で使用する主要技術**:
- **実行環境**: Vercel（推奨）
- **認証**: NextAuth.js（OAuth 2.0）
- **ブラウジング**: Playwright（推奨）
- **スクレイピング**: cheerio（Node.js、推奨）
- **AI**: Gemini 2.5 Flash API
- **通知**: Resend（メール、推奨）、Slack Webhook、LINE Notify
- **定期実行**: Vercel Cron（推奨）
- **データベース**: Supabase（推奨）

## 成功基準

1. **GSC連携**: 自社サイトの順位データが取得できる
2. **順位下落検知**: 急落が正しく検知される
3. **競合分析**: 競合URLが取得でき、記事がスクレイピングできる
4. **リライト案生成**: 具体的な追加項目が箇条書きで生成される
5. **通知**: メール/Slack/LINEに通知が届く
6. **定期実行**: 毎日自動で順位をチェックし、急落時に通知が送信される

## 実装期間の目安

**合計: 約2週間（10-14日）**

- Step 1: 1-2日
- Step 2: 1日
- Step 3: 2-3日
- Step 4: 1-2日
- Step 5: 2-3日
- Step 6: 1-2日
- Step 7: 1日

## 次のステップ（効果を実感した後）

1. **フロントエンド（ダッシュボード）**: 分析結果の閲覧画面
2. **手動スキャン機能**: GSC連携不要で分析できる機能
3. **デモモード**: 成功事例の表示
4. **無料お試し画面**: ログイン不要で価値を体験
5. **アラート設定のカスタマイズ機能**（将来機能）
   - 急落の判定条件をユーザーが設定可能
   - 過去何日間の平均順位かをユーザーが設定可能
   - 設定画面で変更可能

## 将来機能：アラート設定のカスタマイズ

### ユーザーが設定可能な項目

#### 1. 急落の判定条件
- **平均順位の下落幅**: デフォルト2位以上 → ユーザーが1.5位、3位などに変更可能
- **特定キーワードの転落条件**: デフォルト10位以下 → ユーザーが5位、15位などに変更可能

#### 2. 比較期間
- **過去何日間の平均順位**: デフォルト7日間 → ユーザーが3日、14日、30日などに変更可能

#### 3. 通知頻度
- **通知タイミング**: デフォルト毎日 → ユーザーが週1回まとめて、急落時のみなどに変更可能

### 実装方針

- **MVP**: デフォルト設定で動作（過去7日間、2位以上下落、10位以下に転落）
- **将来**: 設定画面でユーザーがカスタマイズ可能
- **データ保存**: ユーザー設定をデータベースに保存

