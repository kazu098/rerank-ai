# キーワード優先度の計算基準

## 概要

「選定された主要キーワード」は、複数の指標を組み合わせた優先度スコアに基づいて選定されます。

## 優先度スコアの計算方法

優先度スコアは、以下の4つの要素の合計で計算されます（最大100点）：

### 1. インプレッション数（最大50点）

- **計算式**: `(インプレッション数 / 1000) × 50`
- **上限**: 50点（インプレッション数が1000以上の場合）
- **例**:
  - インプレッション数 100 → 5点
  - インプレッション数 500 → 25点
  - インプレッション数 1000以上 → 50点

**理由**: インプレッション数が多いキーワードは、多くのユーザーに表示される可能性が高いため、重要度が高い。

### 2. クリック数（最大30点）

- **計算式**: `(クリック数 / 100) × 30`
- **上限**: 30点（クリック数が100以上の場合）
- **例**:
  - クリック数 10 → 3点
  - クリック数 50 → 15点
  - クリック数 100以上 → 30点

**理由**: クリック数が多いキーワードは、実際にユーザーが興味を持ってアクセスしているため、重要度が高い。

### 3. 順位（最大15点）

- **1-5位**: 15点
- **6-10位**: 10点
- **11-20位**: 5点
- **21位以下**: 0点

**理由**: 順位が高い（数字が小さい）キーワードほど、検索結果の上位に表示される可能性が高く、改善効果が大きい。ただし、21位以下は優先度を下げる。

### 4. CTR（最大5点）

- **計算式**: `CTR × 100 × 5`
- **上限**: 5点（CTRが5%以上の場合）
- **例**:
  - CTR 1% → 5点
  - CTR 2% → 10点（上限5点）
  - CTR 5%以上 → 5点

**理由**: CTRが高いキーワードは、検索結果での訴求力が高いため、重要度が高い。

## 転落キーワードの優先度

**転落キーワード（順位が下がったキーワード）は、優先度スコアが2倍になります。**

- 通常の優先度スコア: 100点
- 転落キーワードの優先度スコア: **200点**

**理由**: 順位が下がったキーワードは、緊急に対応が必要なため、優先度を上げる。

## 選定プロセス

### ステップ1: 転落キーワードを優先

1. 順位下落を検知したキーワードを抽出
2. 転落キーワードの優先度スコアを計算（2倍）
3. 優先度の高い順にソート
4. 上位N個を選定（デフォルト: 3個）

### ステップ2: 全体から主要キーワードを追加

転落キーワードが少ない場合（`maxKeywords`未満）、全体のキーワードから主要なものを追加：

1. すべてのキーワードの優先度スコアを計算
2. 優先度の高い順にソート
3. 転落キーワードと重複しないものを選定
4. `maxKeywords`に達するまで追加

### ステップ3: 最終選定

1. 転落キーワード + 追加キーワードを統合
2. 優先度の高い順にソート
3. 上位`maxKeywords`個を最終選定

## 計算例

### 例1: 転落キーワード

| キーワード | インプレッション | クリック | 順位 | CTR | 通常スコア | 転落キーワードスコア |
|-----------|----------------|---------|------|-----|-----------|-------------------|
| ポケとも 価格 | 1,000 | 50 | 10位 | 5% | 50+15+10+5=80点 | **160点** |
| ポケとも 口コミ | 500 | 30 | 15位 | 6% | 25+9+5+5=44点 | **88点** |

### 例2: 通常キーワード

| キーワード | インプレッション | クリック | 順位 | CTR | スコア |
|-----------|----------------|---------|------|-----|--------|
| ポケとも レビュー | 800 | 40 | 8位 | 5% | 40+12+10+5=67点 |
| ポケとも 評判 | 300 | 20 | 12位 | 6.7% | 15+6+5+5=31点 |

## デフォルト設定

- **最大キーワード数**: 3個（`maxKeywords`パラメータで変更可能）
- **転落キーワード優先**: あり（優先度2倍）
- **重複排除**: あり（同じキーワードは1回のみ選定）
- **意味的に同じキーワードのグループ化**: あり（例：「ポケとも 価格」と「ポケ とも 価格」を1つにまとめる）
- **最小インプレッション数**: 10（これ未満のキーワードは除外）

## キーワードのグループ化

意味的に同じキーワード（空白の位置が異なるだけなど）は、自動的にグループ化されて、代表的なキーワードのみが選定されます。

### グループ化の例

| 元のキーワード | 正規化後 | 選定されるキーワード |
|--------------|---------|-------------------|
| ポケとも 価格 | ポケとも 価格 | ポケとも 価格（優先度が高い方） |
| ポケ とも 価格 | ポケとも 価格 | （除外） |
| ポケとも価格 | ポケとも価格 | ポケとも価格（別キーワードとして扱う） |

### グループ化のルール

1. **空白の統一**: 連続する空白を1つに統一
2. **大文字小文字の統一**: すべて小文字に変換
3. **前後の空白を削除**: トリム処理

## インプレッション数の閾値

**最小インプレッション数: 10**

インプレッション数が10未満のキーワードは、検索ボリュームが少ないため、自動的に除外されます。

### 除外される例

- インプレッション数: 5 → **除外**
- インプレッション数: 9 → **除外**
- インプレッション数: 10 → **選定対象**

### 理由

- 検索ボリュームが少ないキーワードは、改善効果が限定的
- リソースを有効活用するため、一定以上の検索ボリュームがあるキーワードに集中

## カスタマイズ

優先度計算の重み付けを変更したい場合は、`lib/keyword-prioritizer.ts`の`calculatePriority`メソッドを編集してください。

### 重み付けの調整例

```typescript
// インプレッション数をより重視する場合
const impressionsScore = Math.min((keyword.impressions / 1000) * 60, 60); // 50 → 60

// 順位をより重視する場合
if (keyword.position <= 5) {
  positionScore = 20; // 15 → 20
}
```

## 参考

- 実装ファイル: `lib/keyword-prioritizer.ts`
- 使用箇所: `lib/competitor-analysis.ts`

