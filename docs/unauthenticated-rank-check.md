# 未ログイン時の順位取得（GSC連携なし）

登録前に「自分の記事の順位＋改善のヒント1つ」を見せるために、GSC連携なしで順位を取得する方法。

## 前提

- **GSC**: サイト単位で連携が必要で、キーワード・順位はGSC APIから取得する。未ログインユーザーには使えない。
- **Serper API**: 「キーワード」でGoogle検索を実行し、検索結果一覧（URL + 順位）を返す。**キーワードさえ分かれば、そのキーワードで指定URLが何位か**を取得できる。GSC不要。

つまり、**「記事URL」だけでは順位は分からない。「どのキーワードでの順位か」を決める必要がある。**

## キーワードの決め方（2通り）

### 方法A: ユーザーにキーワードを入力してもらう（推奨）

- **入力**: 記事URL + **調べたいキーワード**（1つでよい）
- **流れ**:  
  1. ユーザーが「記事のURL」と「このキーワードで何位か知りたい」を入力  
  2. Serper API で `keyword` を検索  
  3. 結果一覧の中で該当URLの位置を探す → それが順位（見つからなければ「100位以下」等と表示）  
  4. 同じ検索結果から上位競合を数件取得し、改善ヒント1つを生成
- **メリット**: 実装が簡単で確実。ユーザーは「メインで狙っているキーワード」を自分で選べる。
- **UI例**: 「記事のURL」「調べたいキーワード（例: 記事のメインキーワード）」の2フィールド。

### 方法B: 記事からキーワードを推測する（オプション）

- **入力**: 記事URLのみ
- **流れ**:  
  1. 記事URLをスクレイプ（既存の `ArticleScraper` や fetch + メタ取得）でタイトル・OG title を取得  
  2. タイトルから「メインキーワード」を1つ決める（ルールベース: 最長の名詞句、またはLLMで1キーワード抽出）  
  3. そのキーワードで Serper 検索 → 該当URLの順位を取得
- **メリット**: 入力がURLだけなので体験がスムーズ。
- **デメリット**: スクレイプ遅延・コスト、推測が外れると「違うキーワードの順位」を見せることになる。記事によってはタイトルと検索キーワードが一致しない。

**実装優先度**: まず **方法A（ユーザーにキーワード入力）** で実装し、必要なら方法Bを「キーワード未入力時は自動推測」として追加するのがよい。

## 技術フロー（方法A）

```
[未ログイン] 記事URL + キーワード 入力
       ↓
SerperApiClient.search(keyword, "Japan", 20)
       ↓
検索結果の organic 一覧で、入力URLと一致するリンクを検索
       ↓
一致した position = そのキーワードでの「現在の順位」
（一致しなければ 100位以下 / 圏外 と表示）
       ↓
同じ結果から上位競合URLを取得 → 既存の競合分析ロジックの簡易版で
「足りない要素1つ」を出し、改善のヒントとして表示
       ↓
「続き（詳細・リライト案）は無料アカウントで」とCTA
```

## 既存コードとの対応

| 役割 | 既存 | 未ログイン用 |
|------|------|--------------|
| 検索結果取得 | `SerperApiClient.search(keyword, location, num)` | 同じAPIをそのまま利用 |
| 自社URLの順位 | `competitor-extractor.ts` の `extractWithSerperApi` 内で、`results.find(r => normalizeUrl(r.url) === normalizedOwnUrl)` で `position` 取得 | 同様のロジックで「順位」だけ取得 |
| 競合・改善ヒント | 競合分析 Step2/Step3、差分分析 | 1キーワード・上位数件のみで簡易版を用意（コスト・時間制約） |

## 制限・注意

- **Serperの料金**: 1検索 ≒ 約1.5円。未ログイン体験は1ユーザー1回〜数回に制限（レート制限・CAPTCHA対策）する想定。
- **順位の意味**: GSCの「平均順位」ではなく、**その時点のSerper検索結果上の位置**。検索はパーソナライズの影響を受けるため、GSCと完全一致はしないが、「だいたい何位付近か」の体験には十分。
- **地域**: `location: "Japan"`, `gl: "jp"` などで日本向け検索に統一（既存Serper呼び出しと同様）。

## まとめ

- GSC連携なしで順位を取るには **Serper API** を使う。
- Serperは「キーワードで検索 → 結果一覧」なので、**キーワードをユーザー入力（または記事から推測）で決める**必要がある。
- 未ログイン体験では、**「記事URL」＋「調べたいキーワード」** の2入力で、そのキーワードでの順位＋改善ヒント1つを表示する形が現実的。
