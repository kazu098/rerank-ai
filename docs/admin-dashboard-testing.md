# 管理画面ダッシュボード動作確認ガイド

## 1. 環境変数の設定

管理画面にアクセスするには、`.env.local` に `ADMIN_EMAIL` を設定する必要があります。

```bash
# .env.local に追加
ADMIN_EMAIL=kazutaka.yoshinaga@gmail.com
```

**重要**: 
- このメールアドレスでログインしたユーザーのみ管理画面にアクセス可能です
- 環境変数を変更した後は、開発サーバーを再起動してください

## 2. 開発サーバーの起動

```bash
npm run dev
```

## 3. 動作確認手順

### 3.1 ログイン

1. ブラウザで `http://localhost:3000` にアクセス
2. Googleアカウントまたはメール・パスワードでログイン
   - **重要**: `ADMIN_EMAIL` で設定したメールアドレスでログインする必要があります

### 3.2 管理画面へのアクセス

1. ログイン後、`http://localhost:3000/admin/dashboard` にアクセス
2. 以下のいずれかが表示されます：
   - **管理者の場合**: 管理画面ダッシュボードが表示される
   - **非管理者の場合**: 通常のダッシュボード（`/dashboard`）にリダイレクトされる

### 3.3 確認項目

#### 基本表示
- [ ] 管理画面のヘッダーが表示される
- [ ] サイドバーにナビゲーションメニューが表示される
- [ ] 現在のユーザーのメールアドレスが表示される

#### KPI表示
- [ ] ユーザー統計が表示される（総数、アクティブ、新規登録など）
- [ ] プラン別ユーザー数が表示される
- [ ] 収益統計（MRR、ARR）が表示される
- [ ] 記事統計が表示される
- [ ] 分析実行統計が表示される
- [ ] サブスクリプション統計が表示される
- [ ] 新規記事提案統計が表示される
- [ ] GSC連携統計が表示される
- [ ] 通知送信統計が表示される

#### 詳細データ表示
- [ ] 最近のユーザー一覧（最新10件）が表示される
- [ ] 最近の分析実行履歴（最新20件）が表示される

#### 数値フォーマット
- [ ] 数値が日本語形式で表示される（例: 1,234）
- [ ] 通貨が日本語形式で表示される（例: ¥12,345）
- [ ] 日時が日本語形式で表示される

#### 前月比表示
- [ ] ユーザー新規登録の前月比が表示される
- [ ] 分析実行回数の前月比が表示される

## 4. トラブルシューティング

### 4.1 403エラーが表示される

**原因**: 管理者権限がない、または環境変数が設定されていない

**対処法**:
1. `.env.local` に `ADMIN_EMAIL` が正しく設定されているか確認
2. ログインしているメールアドレスが `ADMIN_EMAIL` と一致しているか確認
3. 開発サーバーを再起動

### 4.2 データが表示されない

**原因**: データベースにデータがない、またはAPIエラー

**対処法**:
1. ブラウザの開発者ツール（F12）でコンソールエラーを確認
2. ネットワークタブで `/api/admin/dashboard/stats` のレスポンスを確認
3. サーバーログでエラーを確認

### 4.3 リダイレクトループが発生する

**原因**: 認証チェックのロジックに問題がある可能性

**対処法**:
1. ブラウザの開発者ツールでネットワークタブを確認
2. `/api/admin/dashboard/stats` のレスポンスステータスを確認
3. サーバーログで `[Admin Auth]` のエラーメッセージを確認

## 5. APIエンドポイントの直接テスト

管理画面APIを直接テストする場合：

```bash
# ログイン後、セッションクッキーを取得して
curl -X GET http://localhost:3000/api/admin/dashboard/stats \
  -H "Cookie: next-auth.session-token=YOUR_SESSION_TOKEN"
```

**期待されるレスポンス**:
```json
{
  "stats": {
    "users": { ... },
    "plans": { ... },
    "articles": { ... },
    "analyses": { ... },
    ...
  }
}
```

## 6. 本番環境での確認

本番環境では、Vercelの環境変数として `ADMIN_EMAIL` を設定してください：

1. Vercelダッシュボードにログイン
2. プロジェクトを選択
3. **Settings** → **Environment Variables**
4. `ADMIN_EMAIL` を追加（値: `kazutaka.yoshinaga@gmail.com`）
5. 環境を選択（Production, Preview, Development）
6. デプロイ後、`https://your-domain.com/admin/dashboard` にアクセス
