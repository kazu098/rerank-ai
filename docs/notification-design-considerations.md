# 通知機能の設計検討事項

## 概要

通知機能を実装する前に、以下の点を慎重に検討する必要があります。誤判断を避け、意味のある通知のみを送信するための設計方針をまとめます。

## 1. 閾値の設計

### 1.1 比較期間の設定

**問題点:**
- 現在の実装: 過去7日間の平均順位と現在（直近1日）を比較
- 1日だけの変動で通知してしまう可能性がある
- 週末や祝日など、一時的な変動に反応してしまう

**検討事項:**

#### オプションA: 連続下落日数の閾値
```
- 過去7日間の平均順位を基準
- 直近N日間（例: 3日間）連続で下落している場合のみ通知
- メリット: 一時的な変動を除外できる
- デメリット: 本当の急落の検知が遅れる可能性
```

#### オプションB: 移動平均の比較
```
- 過去7日間の移動平均 vs 過去3日間の移動平均
- メリット: より安定した比較が可能
- デメリット: 実装が複雑
```

#### オプションC: 統計的な有意性の検証
```
- 過去N日間の標準偏差を計算
- 現在の順位が平均から標準偏差の2倍以上離れている場合のみ通知
- メリット: 統計的に意味のある変動のみを検知
- デメリット: 実装が複雑、計算コストが高い
```

**推奨: オプションA（連続下落日数の閾値）**
- 実装が簡単
- ユーザーが理解しやすい
- デフォルト: 3日間連続で下落している場合のみ通知

### 1.2 下落幅の閾値

**現在の実装:**
- デフォルト: 2位以上下落

**検討事項:**

#### 相対的な下落率も考慮
```
- 絶対的な下落幅（2位）だけでなく、相対的な下落率も考慮
- 例: 3位 → 5位（2位下落、66%下落）は通知
- 例: 20位 → 22位（2位下落、10%下落）は通知しない
```

#### キーワードごとの重要度
```
- インプレッション数の多いキーワードの下落を優先
- 例: インプレッション1000以上のキーワードが下落した場合のみ通知
```

**推奨:**
- デフォルト: 2位以上下落 + インプレッション数が一定以上（例: 100以上）
- ユーザーがカスタマイズ可能（将来機能）

### 1.3 キーワード転落の閾値

**現在の実装:**
- デフォルト: 10位以下に転落

**検討事項:**

#### 転落の定義を明確化
```
- 10位以下に転落 = 10位、11位、12位...すべて含む？
- それとも10位以下 = 11位以下？
```

#### 転落の継続期間
```
- 1日だけ10位以下になった場合も通知するか？
- 3日間連続で10位以下になった場合のみ通知するか？
```

**推奨:**
- 10位以下 = 11位以下（10位は含まない）
- 3日間連続で10位以下になった場合のみ通知

## 2. 改善済み記事の扱い

### 2.1 修正済みフラグの管理

**問題点:**
- ユーザーが記事を修正しても、SEOに反映されるまで時間がかかる（数日〜数週間）
- 修正後も同じ通知が繰り返し送信されてしまう
- ユーザーが「もう修正したのに」と感じる

**検討事項:**

#### オプションA: 手動で「修正済み」フラグを設定
```
- ユーザーが通知を受け取った後、「修正済み」ボタンをクリック
- その記事は一定期間（例: 30日間）通知を停止
- メリット: シンプル、確実
- デメリット: ユーザーの手間がかかる
```

#### オプションB: 自動で修正を検知
```
- 記事の内容を定期的にスクレイピング
- 前回の通知内容（追加すべき項目）が含まれているかチェック
- 含まれていれば「修正済み」と判定
- メリット: ユーザーの手間がない
- デメリット: 実装が複雑、誤検知の可能性、コストがかかる
```

#### オプションC: 通知履歴を活用
```
- 同じ記事・同じキーワードで過去N日間（例: 7日間）に通知を送信した場合、再通知しない
- メリット: シンプル
- デメリット: 本当に修正していない場合も通知されない
```

**推奨: オプションA + オプションCのハイブリッド**
- デフォルト: 過去7日間同じ記事・同じキーワードで通知を送信した場合、再通知しない
- オプション: ユーザーが「修正済み」フラグを設定できる
- 「修正済み」フラグを設定した場合、30日間通知を停止

### 2.2 改善後の監視期間

**検討事項:**

#### 修正後の再評価タイミング
```
- 修正後、何日後に再評価するか？
- 例: 修正後14日後に再評価
- 例: 修正後30日後に再評価
```

#### 改善が確認できた場合の処理
```
- 順位が改善した場合、通知を送信するか？
- 例: 「修正が効果的でした！順位が3位 → 1位に改善しました」
- メリット: ユーザーのモチベーション向上
- デメリット: 通知が増える
```

**推奨:**
- 修正後14日後に再評価
- 改善が確認できた場合も通知を送信（ポジティブなフィードバック）

### 2.3 修正内容の追跡

**検討事項:**

#### 通知内容の保存
```
- 通知で提案した「追加すべき項目」をデータベースに保存
- 修正済みフラグを設定する際、どの項目を修正したかを記録
- メリット: より詳細な追跡が可能
- デメリット: データ構造が複雑になる
```

#### 修正の自動検知（将来機能）
```
- 記事の内容を定期的にスクレイピング
- 提案された項目が追加されているかチェック
- 追加されていれば自動で「修正済み」と判定
- メリット: ユーザーの手間がない
- デメリット: 実装が複雑、コストがかかる
```

**推奨:**
- MVP: 通知内容を`notifications`テーブルに保存
- 修正済みフラグを設定する際、関連する通知IDを記録
- 将来: 修正の自動検知機能を追加

## 3. その他の考慮事項

### 3.1 通知の頻度制限

**検討事項:**

#### 1記事あたりの通知頻度
```
- 同じ記事に対して、1日1回まで通知
- 同じ記事に対して、1週間に1回まで通知
- メリット: 通知の過多を防ぐ
```

#### 1ユーザーあたりの通知頻度
```
- 1ユーザーに対して、1日1件まで通知（まとめて送信）
- 複数の記事に対する通知がある場合、1つのメールにまとめて送信
- メリット: 通知の過多を防ぐ、ユーザーの負担を軽減
- デメリット: 重要な通知が埋もれる可能性（優先度で解決）
```

**推奨:**
- 1記事あたり: 過去7日間で1回まで通知
- 1ユーザーあたり: 1日1件まで通知（複数の記事に対する通知をまとめて送信）

#### まとめ通知の形式
```
- 件名: 【ReRank AI】順位下落を検知しました（N件の記事）
- 本文:
  1. 記事1: URL、下落したキーワード、下落幅、追加すべき項目（1-3個）
  2. 記事2: URL、下落したキーワード、下落幅、追加すべき項目（1-3個）
  ...
  N. 記事N: URL、下落したキーワード、下落幅、追加すべき項目（1-3個）
  
  詳細はダッシュボードで確認: [リンク]
```

**メリット:**
- 通知の過多を防ぐ
- ユーザーの負担を軽減
- 複数の記事を一度に確認できる

**デメリット:**
- 重要な通知が埋もれる可能性（優先度で解決、将来機能）

### 3.2 通知の優先度

**検討事項:**

#### 優先度の定義
```
- 高: 平均順位が5位以上下落、または重要なキーワード（インプレッション1000以上）が10位以下に転落
- 中: 平均順位が2-5位下落、または中程度のキーワード（インプレッション100-1000）が10位以下に転落
- 低: 平均順位が2位未満の下落、または低いキーワード（インプレッション100未満）が10位以下に転落
```

#### 優先度に応じた通知方法
```
- 高: 即座に通知（メール + Slack/LINE）
- 中: 通常の通知（メールのみ）
- 低: まとめて通知（週1回）
```

**推奨:**
- MVP: 優先度の概念は導入しない（すべて同じ優先度）
- 将来: 優先度に応じた通知方法を実装

### 3.3 データの信頼性

**検討事項:**

#### GSCデータの遅延
```
- GSCデータは1-2日遅れで反映される
- 2日前のデータを取得しているが、それでも変動が大きい場合がある
- データが少ない期間（例: 週末）は通知しない方が良いか？
```

#### データの欠落
```
- GSC APIは100位以内のページのみを返す
- データが取得できない期間がある場合、転落している可能性が高い
- データ欠落を「転落」として通知するか？
```

**推奨:**
- データが少ない期間（1日のインプレッション数が10未満）は通知しない
- データ欠落は「転落の可能性」として通知（警告レベル）

### 3.4 通知内容の最適化

**検討事項:**

#### 通知内容の簡潔化
```
- 長い通知は読まれない
- 要点だけを簡潔に伝える
- 詳細はダッシュボードで確認できるようにする
```

#### アクション可能な内容
```
- 抽象的なアドバイスではなく、具体的なアクションを提示
- 例: 「価格比較表を追加してください」ではなく「価格比較表を追加してください（競合サイト: URL1, URL2）」
```

**推奨:**
- 通知内容は3-5行以内に収める
- 具体的なアクションを1-3個提示
- 詳細はダッシュボードへのリンクを提供

### 3.5 エラーハンドリング

**検討事項:**

#### 通知送信の失敗
```
- メール送信に失敗した場合、リトライするか？
- 何回までリトライするか？
- リトライの間隔は？
```

#### 分析の失敗
```
- 分析中にエラーが発生した場合、通知を送信するか？
- エラー内容を通知するか？
```

**推奨:**
- 通知送信の失敗: 3回までリトライ、間隔は1時間、1日、1週間
- 分析の失敗: エラー内容を簡潔に通知（「分析中にエラーが発生しました。しばらくしてから再度お試しください」）

## 4. 実装方針（推奨）

### Phase 1: MVP（最小実装）

1. **閾値の設定**
   - 過去7日間の平均順位 vs 直近3日間の平均順位
   - 3日間連続で2位以上下落している場合のみ通知
   - インプレッション数100以上のキーワードが3日間連続で10位以下になった場合のみ通知

2. **通知の頻度制限**
   - 1記事あたり: 過去7日間で1回まで通知
   - 1ユーザーあたり: 1日1件まで通知（複数の記事に対する通知をまとめて送信）

3. **修正済みフラグ**
   - 手動で「修正済み」フラグを設定可能
   - 修正済みフラグを設定した場合、30日間通知を停止
   - 通知履歴を活用して、過去7日間同じ記事・同じキーワードで通知を送信した場合、再通知しない

4. **通知内容**
   - まとめ通知形式: 1日1件のメールに複数の記事をまとめて送信
   - 各記事: 簡潔に（3-5行以内）、具体的なアクションを1-3個提示
   - ダッシュボードへのリンクを提供

### Phase 2: 改善（将来機能）

1. **閾値のカスタマイズ**
   - ユーザーが閾値を設定可能
   - 比較期間、下落幅、転落条件をカスタマイズ可能

2. **修正の自動検知**
   - 記事の内容を定期的にスクレイピング
   - 提案された項目が追加されているかチェック
   - 追加されていれば自動で「修正済み」と判定

3. **優先度に応じた通知**
   - 優先度に応じた通知方法を実装
   - 高優先度は即座に通知、低優先度はまとめて通知

4. **改善確認の通知**
   - 修正後14日後に再評価
   - 改善が確認できた場合も通知を送信

## 5. データベース設計（追加が必要な項目）

### articlesテーブルに追加
```sql
ALTER TABLE articles ADD COLUMN is_fixed BOOLEAN DEFAULT false;
ALTER TABLE articles ADD COLUMN fixed_at TIMESTAMP WITH TIME ZONE;
ALTER TABLE articles ADD COLUMN fixed_notification_id UUID REFERENCES notifications(id);
ALTER TABLE articles ADD COLUMN last_notification_sent_at TIMESTAMP WITH TIME ZONE;
ALTER TABLE articles ADD COLUMN notification_count_last_7_days INTEGER DEFAULT 0;
```

### notificationsテーブルに追加
```sql
ALTER TABLE notifications ADD COLUMN notification_key VARCHAR(255); -- 記事ID + キーワードのハッシュ（重複チェック用）
ALTER TABLE notifications ADD COLUMN priority VARCHAR(20) DEFAULT 'medium'; -- 'high', 'medium', 'low'
ALTER TABLE notifications ADD COLUMN is_fixed BOOLEAN DEFAULT false;
```

### notification_settingsテーブルに追加
```sql
ALTER TABLE notification_settings ADD COLUMN consecutive_drop_days INTEGER DEFAULT 3; -- 連続下落日数の閾値
ALTER TABLE notification_settings ADD COLUMN min_impressions INTEGER DEFAULT 100; -- 最小インプレッション数
ALTER TABLE notification_settings ADD COLUMN notification_cooldown_days INTEGER DEFAULT 7; -- 通知のクールダウン期間
```

## 6. まとめ

通知機能を実装する際は、以下の点を重視する:

1. **誤判断を避ける**: 連続下落日数の閾値、インプレッション数の閾値を設定
2. **通知の過多を防ぐ**: 通知頻度制限、修正済みフラグの活用
3. **ユーザーの手間を減らす**: 修正済みフラグの設定、通知内容の簡潔化
4. **将来の拡張性**: 閾値のカスタマイズ、修正の自動検知などの将来機能を見据えた設計

MVPでは、シンプルな実装から始め、ユーザーのフィードバックを元に改善していく方針が良いでしょう。

