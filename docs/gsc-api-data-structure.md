# Google Search Console API データ構造

## 取得可能なデータ

Google Search Console APIを使用することで、以下のデータを取得できます。

### 1. 特定記事の時系列データ

**エンドポイント**: `searchAnalytics.query`

**取得可能なデータ**:
- **日付**: 時系列での順位変動を追跡
- **順位（Position）**: 平均順位（小数点含む）
- **インプレッション（Impressions）**: 検索結果に表示された回数
- **クリック数（Clicks）**: 実際にクリックされた回数
- **CTR（Click-Through Rate）**: クリック率

**データ例**:
```json
{
  "rows": [
    {
      "keys": ["2025-12-11"],
      "impressions": 703,
      "clicks": 26,
      "ctr": 0.03698435277382646,
      "position": 4.199146514935989
    },
    {
      "keys": ["2025-12-22"],
      "impressions": 936,
      "clicks": 23,
      "ctr": 0.024572649572649572,
      "position": 6.77991452991453
    }
  ],
  "responseAggregationType": "byPage"
}
```

### 2. キーワード（クエリ）ごとの分析

**取得可能なデータ**:
- **キーワード（Query）**: 検索クエリ
- **順位（Position）**: そのキーワードでの平均順位
- **CTR**: クリック率
- **インプレッション**: 表示回数

**分析例**:
| キーワード | 順位 | CTR | 診断結果 |
|----------|------|-----|---------|
| ポケトモ 口コミ | 3.77位 | 2.9% | 主力：維持が必要 |
| ポケトモ 高齢者 | 4.07位 | 4.6% | 重要：ターゲットに合致 |
| ポケトモ デメリット | 2.33位 | 7.2% | 最強：ユーザーの信頼が高い |
| ポケトモ 価格 | 10.04位 | 0.3% | 落選：2ページ目に転落 |
| ポケトモ 月額 | 9.11位 | 0.2% | 落選：順位低下の主因 |

## 順位下落の検知ロジック

### 時系列データの比較

1. **基準日の設定**
   - 過去N日間の平均順位を基準とする（例：過去7日間の平均）
   - または、特定の日付を基準とする

2. **下落の判定**
   - 現在の平均順位と基準日の平均順位を比較
   - 例：4.1位（12/11）→ 6.7位（12/22）は約2.6位の下落

3. **キーワードごとの分析**
   - 全体の順位下落の原因を特定
   - 例：「価格」「月額」などのキーワードが10位前後に沈んでいる

### 実装例

```javascript
// 順位下落の検知
const baseDate = '2025-12-11';
const currentDate = '2025-12-22';
const basePosition = 4.1;
const currentPosition = 6.7;

const positionDrop = currentPosition - basePosition; // 2.6位下落

if (positionDrop >= 2.0) {
  // 急落と判定
  // キーワードごとの分析を実行
  analyzeByKeyword(articleUrl, baseDate, currentDate);
}
```

## キーワードごとの優先順位付け

### 診断結果の分類

1. **最強**: 順位が高く、CTRも高い（例：2.33位、CTR 7.2%）
   - 維持が必要

2. **重要**: 順位は中程度だが、CTRが高い（例：4.07位、CTR 4.6%）
   - ターゲットに合致している可能性

3. **主力**: 順位は高いが、CTRが低い（例：3.77位、CTR 2.9%）
   - タイトルや説明文の改善が必要かも

4. **落選**: 順位が低い（例：10位前後）
   - 2ページ目に転落
   - 順位低下の主因となる可能性

### 分析の優先順位

1. **「落選」キーワードの分析を最優先**
   - 順位が10位前後のキーワードが、全体の順位を下げている可能性
   - これらのキーワードで競合分析を実行

2. **「最強」「重要」キーワードの維持**
   - 現在順位が高いキーワードの維持も重要
   - 競合が追い上げてきた場合の対策

## 実装上の考慮事項

### 1. データ取得の頻度

- **定期実行**: 毎日1回、前日のデータを取得
- **データの遅延**: GSCデータは通常1-2日遅れで反映される

### 2. データの保存

- **時系列データ**: 日次で保存し、過去のデータと比較可能にする
- **キーワードデータ**: キーワードごとの順位変動を追跡

### 3. 急落の定義（再定義）

実際のデータを踏まえた定義：

- **急落の定義**:
  - 平均順位が2位以上下落
  - または、特定のキーワードが10位以下に転落
  - または、インプレッションが30%以上減少

### 4. 通知の内容

順位下落を検知した場合、以下の情報を含める：

1. **全体の順位変動**
   - 例：「12/11の4.1位から12/22の6.7位に下落（2.6位下落）」

2. **原因となったキーワード**
   - 例：「価格」「月額」などのキーワードが10位前後に沈んでいる

3. **具体的な改善案**
   - 下落したキーワードで競合分析を実行
   - リライト原稿を生成

## 参考リンク

- [Google OAuth 2.0 Playground](https://developers.google.com/oauthplayground/)
- [Search Console API ドキュメント](https://developers.google.com/webmaster-tools/search-console-api-original)
- スコープ: `https://www.googleapis.com/auth/webmasters.readonly`

