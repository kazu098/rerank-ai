# Slack OAuth 複数ワークスペース対応の検討

## 現状の動作

現在の実装では、**ユーザーがOAuth認証時に選択したワークスペースにのみ通知が送信されます**。

### 重要な理解

⚠️ **Slack App作成時に開発者が選択するワークスペースは関係ありません。**

- 開発者がSlack Appを作成する際に選択するワークスペースは、開発用の「ホームワークスペース」です
- **各ユーザーはOAuth認証時に自分の所属するワークスペースを選択します**
- 選択したワークスペースにBotがインストールされ、そのワークスペースに通知が送信されます
- つまり、**各ユーザーが自分のワークスペースに通知を受け取れます**

### 動作フロー

1. **開発者**: Slack Appを作成（任意のワークスペースでOK）
2. **ユーザー**: アプリの設定画面で「Slackと連携」ボタンをクリック
3. **ユーザー**: Slack OAuth認証画面で**自分の所属するワークスペースを選択**
4. **ユーザー**: 選択したワークスペースのBot Tokenが取得される
5. **通知**: 選択したワークスペース内のチャンネルまたはDMに通知が送信される

### 制限事項

- **1ユーザー = 1ワークスペース**: 1人のユーザーは1つのワークスペースにしか通知できない
- **ワークスペース間の切り替え不可**: 別のワークスペースに通知したい場合は、連携を解除して再認証する必要がある

## 解決策の選択肢

### 案1: 各ユーザーが自分のワークスペースにSlack Appをインストール（現状維持）

**仕組み**:
- 開発者が1つのSlack Appを作成
- 各ユーザーがそのSlack Appを**自分のワークスペースにインストール**
- 各ユーザーのBot Tokenを個別に保存

**メリット**:
- ✅ 実装が簡単（現状の実装で対応可能）
- ✅ 各ユーザーが自分のワークスペースに通知を受け取れる
- ✅ セキュリティ面でも問題なし（各ユーザーのTokenを個別管理）

**デメリット**:
- ❌ ユーザーが複数のワークスペースに通知したい場合に対応できない
- ❌ ワークスペースを切り替えるには再認証が必要

**実装**:
- 現状の実装で対応可能
- ユーザーに「自分のワークスペースにSlack Appをインストールしてください」と案内

---

### 案2: 複数ワークスペース対応（1ユーザーが複数ワークスペースに通知可能）

**仕組み**:
- 1人のユーザーが複数のワークスペースにSlack Appをインストール
- 各ワークスペースのBot Tokenを個別に保存
- 通知設定画面で通知先ワークスペースを選択可能

**メリット**:
- ✅ 1人のユーザーが複数のワークスペースに通知可能
- ✅ ワークスペースごとに通知先（チャンネル/DM）を設定可能

**デメリット**:
- ❌ 実装が複雑（複数のToken管理が必要）
- ❌ UIが複雑になる（ワークスペース選択、通知先設定など）

**実装内容**:
1. **DBスキーマの変更**
   ```sql
   -- notification_settingsテーブルを1対多に変更
   -- または、slack_workspacesテーブルを新規作成
   CREATE TABLE slack_workspaces (
     id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
     user_id UUID NOT NULL REFERENCES users(id),
     workspace_id VARCHAR(50) NOT NULL, -- Slack Team ID
     workspace_name VARCHAR(255),
     bot_token TEXT NOT NULL,
     user_id_slack VARCHAR(50), -- Slack User ID
     channel_id VARCHAR(50), -- 通知先チャンネルIDまたはUser ID
     notification_type VARCHAR(20) DEFAULT 'dm', -- 'channel' or 'dm'
     is_active BOOLEAN DEFAULT true,
     created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
     updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
     UNIQUE(user_id, workspace_id)
   );
   ```

2. **設定画面UIの変更**
   - ワークスペース一覧表示
   - 「新しいワークスペースを追加」ボタン
   - 各ワークスペースごとの通知先設定（チャンネル/DM選択）

3. **通知送信ロジックの変更**
   - ユーザーに紐づく全アクティブなワークスペースに通知を送信
   - または、ユーザーが選択したワークスペースにのみ送信

---

### 案3: 共有ワークスペース（全ユーザーが同じワークスペースに通知）

**仕組み**:
- 開発者が1つのSlack Appを作成し、1つのワークスペースにインストール
- 全ユーザーがそのワークスペースの同じチャンネルに通知を受け取る

**メリット**:
- ✅ 実装が最も簡単
- ✅ 管理が簡単（1つのTokenのみ）

**デメリット**:
- ❌ 全ユーザーが同じチャンネルを見ることになる（プライバシーの問題）
- ❌ ユーザーごとに異なるチャンネルに通知したい場合に対応できない
- ❌ ユーザーが自分のワークスペースに通知を受け取れない

**実装**:
- 環境変数で1つのBot Tokenを設定
- 全ユーザーに同じチャンネルに通知

---

## 推奨案

### 現時点: **案1（現状維持）**を推奨

**理由**:
1. **実装が簡単**: 現状の実装で対応可能
2. **セキュリティ**: 各ユーザーが自分のワークスペースにのみアクセス可能
3. **柔軟性**: 各ユーザーが自分のワークスペースで自由に設定可能
4. **スケーラビリティ**: ユーザー数が増えても問題なし

### 将来的な拡張: **案2（複数ワークスペース対応）**

**実装タイミング**:
- ユーザーから「複数のワークスペースに通知したい」という要望が出た場合
- または、企業向け機能として実装

**実装優先度**: 低（現時点では案1で十分）

---

## ユーザーへの案内

### 設定手順の説明

1. **Slack Appのインストール**
   - 各ユーザーが自分のワークスペースにSlack Appをインストール
   - これはOAuth認証時に自動的に行われます

2. **通知先の選択**
   - デフォルト: 自分のDM
   - オプション: チャンネル（将来的に実装）

3. **複数ワークスペースへの通知が必要な場合**
   - 現時点では対応していません
   - 将来的に対応予定（要望があれば）

---

## 実装の変更が必要な場合

もし案2（複数ワークスペース対応）を実装する場合、以下の変更が必要です：

1. **DBスキーマの変更**（上記参照）
2. **OAuth認証フローの変更**
   - 既存のワークスペースを確認
   - 新しいワークスペースを追加するUI
3. **設定画面UIの変更**
   - ワークスペース一覧表示
   - 各ワークスペースごとの設定
4. **通知送信ロジックの変更**
   - 複数のワークスペースに通知を送信

**実装期間**: 2-3日

