# 実装優先順位

## ✅ 実装完了項目

以下の機能は既に実装済みです：

### Phase 1: 最小実装（自社サイトで効果を実感・GSC連携必須）

- ✅ OAuth 2.0認証の実装（1クリックでGSC連携）
  - NextAuth.jsを使用したGoogle OAuth 2.0認証
  - GSC APIスコープ（`https://www.googleapis.com/auth/webmasters.readonly`）の取得
- ✅ GSC API連携（順位データ取得）
  - 特定記事の時系列データ取得
  - キーワード（クエリ）ごとの順位データ取得
  - GSCトークンの自動リフレッシュ機能
- ✅ 順位下落検知ロジック
  - 過去7日間の平均順位と現在の平均順位を比較
  - 急落の判定（平均順位が2位以上下落、または特定キーワードが10位以下に転落）
- ✅ ブラウジングツールでの競合URL取得
  - Serper APIを使用した競合URL抽出
  - 自社URLより上位のサイトURLを抽出
- ✅ 競合記事スクレイピング
  - cheerioを使用したHTMLパース
  - テキスト抽出
- ✅ 差分分析とリライト案生成（Gemini 2.5 Flash）
  - 自社記事と競合記事の比較
  - 箇条書き形式で追加すべき項目を生成
- ✅ メール通知機能
  - Resendを使用したメール送信
  - まとめ通知機能（複数記事を1つのメールに）
  - 多言語対応（ja/en）
- ✅ 定期実行（Cron）
  - Vercel Cronで毎日1回自動実行
  - 順位下落をチェックして通知を送信
- ✅ 通知設定UI
  - 分析結果画面で通知設定を登録
  - タイムゾーン対応

---

## 🎯 次に実装すべき項目（推奨実装順序）

### 1. 分析結果のDB保存（最優先）

**目的**: 分析結果をデータベースに保存し、履歴を管理できるようにする

**実装内容**:
1. `lib/db/analysis-results.ts` を作成
   - `saveAnalysisResult()` 関数を実装
   - `getAnalysisResultsByArticleId()` 関数を実装
   - `getLatestAnalysisResult()` 関数を実装
2. 分析実行時にDBに保存
   - `analysis_runs` テーブルに実行履歴を記録
   - `analysis_results` テーブルに分析結果サマリーを保存
   - 詳細データは一時ストレージに保存（オプション、後で実装）
3. 分析完了時の処理を追加
   - `app/[locale]/page.tsx` の分析完了時にDB保存を追加
   - エラーハンドリングを追加

**成果物**:
- `lib/db/analysis-results.ts` - 分析結果のDB操作関数
- 分析実行時のDB保存処理

**期間**: 1-2日

**重要**: 
- 分析結果を保存しないと、ダッシュボードで表示できない
- 通知履歴と分析結果を紐付けるために必要

---

### 2. 管理画面（ダッシュボード）の基本実装

**目的**: ユーザーが分析結果を確認し、記事を管理できる画面を提供

**実装内容**:
1. `/dashboard` ページを作成
   - ログイン必須のページ
   - レイアウト設計（サイドバー、メインコンテンツ）
2. 記事一覧表示
   - 登録済み記事の一覧表示
   - 各記事の最新の分析結果（平均順位、前回順位、変化量）を表示
   - 記事の追加・削除機能
3. 分析結果一覧表示
   - 記事ごとの分析結果履歴を表示
   - 分析結果詳細ページへのリンク
4. 未読通知の表示
   - 未読通知の一覧表示
   - 通知をクリックで詳細表示

**成果物**:
- `app/[locale]/dashboard/page.tsx` - ダッシュボードメインページ
- `app/[locale]/dashboard/articles/page.tsx` - 記事一覧ページ
- `app/[locale]/dashboard/articles/[id]/page.tsx` - 記事詳細ページ
- `app/api/dashboard/data/route.ts` - ダッシュボード用データ取得API

**期間**: 2-3日

**重要**: 
- ユーザーが分析結果を確認できる唯一の場所
- 記事管理の基盤となる

---

### 3. 通知履歴の表示

**目的**: ユーザーが過去の通知を確認できるようにする

**実装内容**:
1. 通知履歴一覧の表示
   - ダッシュボードに通知履歴セクションを追加
   - 通知日時、記事URL、通知内容を表示
   - 未読/既読の状態を表示
2. 通知詳細の表示
   - 通知をクリックで詳細表示
   - 分析結果へのリンク
3. 通知の既読機能
   - 通知をクリックしたら既読にする
   - `notifications.read_at` を更新

**成果物**:
- `app/[locale]/dashboard/notifications/page.tsx` - 通知履歴ページ
- `app/api/notifications/mark-as-read/route.ts` - 通知既読API

**期間**: 1日

---

### 4. 修正済みフラグのUI

**目的**: ユーザーが記事を「修正済み」とマークできるようにする

**実装内容**:
1. 修正済みフラグ設定UI
   - 記事詳細ページまたは通知詳細ページに「修正済み」ボタンを追加
   - 修正済みにした日時を記録
2. 修正済みフラグ更新API
   - `/api/articles/mark-as-fixed` エンドポイントを作成
   - `articles.is_fixed` と `articles.fixed_at` を更新
3. 修正済み記事の表示
   - ダッシュボードで修正済み記事を視覚的に区別
   - 修正済み記事は通知対象から除外（既に実装済み）

**成果物**:
- `app/api/articles/mark-as-fixed/route.ts` - 修正済みフラグ更新API
- 記事詳細ページまたは通知詳細ページにUI追加

**期間**: 1日

---

### 5. ユーザーのロケール設定

**目的**: 通知メールの言語をユーザー設定に合わせる

**実装内容**:
1. `users` テーブルに `locale` カラムを追加
   - マイグレーションファイルを作成
   - デフォルト値: 'ja'
2. フロントエンドでロケールを保存
   - ログイン時または設定画面でロケールを保存
   - `next-intl` のロケール設定をDBに保存
3. Cronジョブでユーザーのロケールを使用
   - `/api/cron/check-rank` でユーザーのロケールを取得
   - 通知メールの言語をユーザー設定に合わせる

**成果物**:
- `supabase/migrations/004_user_locale.sql` - ロケールカラム追加
- `lib/db/users.ts` - ロケール更新関数
- `app/api/users/update-locale/route.ts` - ロケール更新API
- Cronジョブのロケール取得処理

**期間**: 0.5日

---

## 実装フェーズ（将来）

### Phase 2: 手動スキャン機能（GSC連携不要）

- [ ] 1記事分析のロジック（ブラウジングツール + 自前クローラー + Gemini）
  - ブラウジングツール（Playwright、Puppeteer等）で競合URLを取得
  - ブラウジングツールで現在の順位を特定
  - キーワード入力またはAI推測
  - 自前クローラー（Beautiful Soup/cheerio等）で競合記事スクレイピング
  - CAPTCHA対応（リトライ機能、ユーザーエージェントローテーション等）
- [ ] 無料お試し画面（ログイン不要）
  - URL入力フォーム
  - 現在の順位表示
  - 改善案の一部表示
- [ ] デモモード（成功事例表示）

**期間**: 1-2週間

### Phase 3: 通知の多様化と設定

- [ ] Slack通知
- [ ] LINE通知
- [ ] 通知頻度設定（優先度低）
  - 例：毎日、週1回まとめて、急落時のみなど
- [ ] **アラート設定のカスタマイズ機能**（将来機能）
  - 急落の判定条件をユーザーが設定可能
    - 平均順位の下落幅（デフォルト2位以上 → 1.5位、3位などに変更可能）
    - 特定キーワードの転落条件（デフォルト10位以下 → 5位、15位などに変更可能）
  - 過去何日間の平均順位かをユーザーが設定可能（デフォルト7日間 → 3日、14日、30日などに変更可能）
  - 設定画面で変更可能

**期間**: 1週間（通知の多様化）+ 追加1週間（アラート設定のカスタマイズ）

**注意**: 
- 通知頻度設定は必要だが、優先度は低い（MVPではデフォルト設定で開始）
- アラート設定のカスタマイズは将来機能（MVPでは不要）

### Phase 4: 有料プラン機能

- [ ] プラン管理
- [ ] 使用回数の制限
- [ ] 決済機能（Stripe等）

**期間**: 2週間

### Phase 5: 追加機能（将来）

- [ ] WordPress連携（WordPressユーザーではない人もいるため、後回し）
  - リライト案をワンクリックでWPに反映
  - 料金: +月額1,000円

**期間**: 未定（需要を確認してから実装）

---

## 技術的な考慮事項

### エラーハンドリング

- API制限に達した場合の対応
- 競合サイトが取得できない場合の対応
- GSCデータが取得できない場合の対応

### パフォーマンス

- 分析の実行時間を30秒以内に
- キャッシュの活用でコスト削減
- 同時実行数の制限

### セキュリティ

- GSCデータの暗号化
- APIキーの安全な管理
- ユーザーデータの保護
