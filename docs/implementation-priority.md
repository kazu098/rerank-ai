# 実装優先順位

## ✅ 実装完了項目

以下の機能は既に実装済みです：

### Phase 1: 最小実装（自社サイトで効果を実感・GSC連携必須）

- ✅ OAuth 2.0認証の実装（1クリックでGSC連携）
  - NextAuth.jsを使用したGoogle OAuth 2.0認証
  - GSC APIスコープ（`https://www.googleapis.com/auth/webmasters.readonly`）の取得
- ✅ ログイン機能
  - NextAuth.jsを使用したGoogle OAuth 2.0ログイン
  - ユーザー情報のDB保存（`users`テーブル）
  - セッション管理
- ✅ GSC API連携（順位データ取得）
  - 特定記事の時系列データ取得
  - キーワード（クエリ）ごとの順位データ取得
  - GSCトークンの自動リフレッシュ機能
- ✅ 順位下落検知ロジック
  - 過去7日間の平均順位と現在の平均順位を比較
  - 急落の判定（平均順位が2位以上下落、または特定キーワードが10位以下に転落）
- ✅ ブラウジングツールでの競合URL取得
  - Serper APIを使用した競合URL抽出
  - 自社URLより上位のサイトURLを抽出
- ✅ 競合記事スクレイピング
  - cheerioを使用したHTMLパース
  - テキスト抽出
- ✅ 差分分析とリライト案生成（Gemini 2.5 Flash）
  - 自社記事と競合記事の比較
  - 箇条書き形式で追加すべき項目を生成
- ✅ メール通知機能
  - Resendを使用したメール送信
  - まとめ通知機能（複数記事を1つのメールに）
  - 多言語対応（ja/en）
- ✅ 定期実行（Cron）
  - Vercel Cronで毎日1回自動実行
  - 順位下落をチェックして通知を送信
- ✅ 通知設定UI
  - 分析結果画面で通知設定を登録
  - タイムゾーン対応
- ✅ ログイン機能の拡張
  - NextAuth.jsでメール/パスワード認証を追加（Credentials Provider）
  - ユーザー登録APIとメール認証機能を実装
  - ログイン画面を作成（メール/パスワード + Google OAuth）
  - Gmail自動入力機能（localStorage活用）
- ✅ ダッシュボード基本実装
  - ダッシュボードメインページ（記事一覧、未読通知、統計情報）
  - ダッシュボード用データ取得API
  - 多言語対応
  - 分析結果画面からダッシュボードへのリンク

---

## 🎯 次に実装すべき項目（推奨実装順序）

### 1. 詳細データの一時ストレージ保存（Vercel Blob Storage）（✅ 実装済み）

**目的**: 再生成コストが高いLLM分析の詳細データを一時ストレージに保存し、詳細画面で表示できるようにする

**実装内容**:
1. ✅ Vercel Blob Storageのセットアップ
   - ✅ `@vercel/blob` パッケージをインストール
   - ✅ 環境変数 `BLOB_READ_WRITE_TOKEN` を設定
2. ✅ 詳細データ保存機能の実装
   - ✅ `lib/db/analysis-results.ts` の `saveAnalysisResult()` を拡張
   - ✅ LLM分析の詳細（`semanticDiffAnalysis`）をVercel Blob Storageに保存
   - ✅ 保存したストレージキーと有効期限をDBに保存（`detailed_result_storage_key`, `detailed_result_expires_at`）
3. ✅ 詳細データ取得機能の実装
   - ✅ `getDetailedAnalysisData()` 関数を実装
   - ✅ ストレージキーから詳細データを取得
   - ✅ 有効期限切れの場合はエラーハンドリング
4. ✅ 分析実行時の処理を追加
   - ✅ `app/api/analysis/save/route.ts` で詳細データを保存
   - ✅ エラーハンドリングを追加

**保存するデータ**:
- ✅ LLM分析の詳細（`semanticDiffAnalysis`）: 10-50KB
  - 理由: 再生成コストが高い（約2.5円）
- ❌ 自社記事の全文: 保存しない（必要時にURLから再取得、コスト: 0円）
- ❌ 競合記事の全文: 保存しない（必要時に再取得）
- ❌ 時系列データ: 保存しない（必要時にGSC APIで再取得）

**成果物**:
- `lib/db/analysis-results.ts` - 詳細データ保存・取得関数の追加
- `app/api/analysis/save/route.ts` - 詳細データ保存処理の追加
- Vercel Blob Storageへの保存処理

**期間**: 1-2日

**重要**: 
- 詳細画面で分析結果の詳細を表示するために必要
- 再生成コストが高いため、保存することでコスト削減
- 30日間の有効期限で自動削除（Vercel Blob StorageのTTL機能）

**参考資料**:

---

### 2. 分析結果のDB保存（✅ 実装済み）

**目的**: 分析結果をデータベースに保存し、履歴を管理できるようにする

**実装内容**:
1. ✅ `lib/db/analysis-results.ts` を作成済み
   - ✅ `saveAnalysisResult()` 関数を実装済み
   - ✅ `getAnalysisResultsByArticleId()` 関数を実装済み
   - ✅ `getLatestAnalysisResult()` 関数を実装済み
2. ✅ 分析実行時にDBに保存済み
   - ✅ `analysis_runs` テーブルに実行履歴を記録
   - ✅ `analysis_results` テーブルに分析結果サマリーを保存
   - ⚠️ 詳細データは一時ストレージに保存（上記「1. 詳細データの一時ストレージ保存」で実装）

**成果物**:
- ✅ `lib/db/analysis-results.ts` - 分析結果のDB操作関数
- ✅ 分析実行時のDB保存処理

**期間**: 1-2日（実装済み）

**重要**: 
- ✅ 分析結果を保存しないと、ダッシュボードで表示できない
- ✅ 通知履歴と分析結果を紐付けるために必要

---

### 3. 管理画面（ダッシュボード）の基本実装（✅ 実装済み）

**目的**: ユーザーが分析結果を確認し、記事を管理できる画面を提供

**実装内容**:
1. ✅ `/dashboard` ページを作成
   - ✅ ログイン必須のページ
   - ✅ レイアウト設計（ヘッダー、サイドバー、メインコンテンツ）
2. ✅ 記事一覧表示
   - ✅ 登録済み記事の一覧表示
   - ✅ 各記事の最新の分析結果（平均順位、前回順位、変化量）を表示
   - ✅ 記事の削除機能
3. ✅ 分析結果一覧表示
   - ✅ 記事ごとの分析結果履歴を表示
   - ✅ 分析結果詳細ページへのリンク
   - ✅ 詳細データの自動表示（Vercel Blob Storageから取得）
4. ✅ 未読通知の表示
   - ✅ 未読通知の一覧表示
   - ✅ 通知をクリックで記事詳細ページに遷移

**成果物**:
- ✅ `app/[locale]/dashboard/page.tsx` - ダッシュボードメインページ
- ✅ `app/[locale]/dashboard/layout.tsx` - 共通レイアウト（サイドバー含む）
- ✅ `app/[locale]/dashboard/articles/page.tsx` - 記事一覧ページ（フィルタ・ソート機能付き）
- ✅ `app/[locale]/dashboard/articles/[id]/page.tsx` - 記事詳細ページ
- ✅ `app/api/dashboard/data/route.ts` - ダッシュボード用データ取得API
- ✅ `app/api/articles/[id]/route.ts` - 記事詳細取得・削除API
- ✅ `app/api/articles/[id]/mark-as-fixed/route.ts` - 修正済みフラグ設定API
- ✅ `app/api/analysis/detailed/route.ts` - 詳細分析データ取得API

**期間**: 2-3日（実装完了）

**重要**: 
- ✅ ユーザーが分析結果を確認できる場所を提供
- ✅ 記事管理の基盤（詳細ページ含む）

---

### 4. 通知履歴の表示（✅ 実装済み）

**目的**: ユーザーが過去の通知を確認できるようにする

**実装内容**:
1. ✅ 通知履歴一覧の表示
   - ✅ 通知履歴ページ（`/dashboard/notifications`）を作成
   - ✅ 通知日時、記事URL、通知内容を表示
   - ✅ 未読/既読の状態を表示
   - ✅ フィルタ機能（すべて/未読/既読）
2. ✅ 通知詳細の表示
   - ✅ 通知をクリックで記事詳細ページに遷移
   - ✅ 分析結果へのリンク
3. ✅ 通知の既読機能
   - ✅ 通知をクリックしたら自動的に既読にする
   - ✅ `notifications.read_at` を更新

**成果物**:
- ✅ `app/[locale]/dashboard/notifications/page.tsx` - 通知履歴ページ
- ✅ `app/api/notifications/route.ts` - 通知一覧取得API
- ✅ `app/api/notifications/[id]/mark-as-read/route.ts` - 通知既読API
- ✅ `lib/db/notifications.ts` - 通知関連のDB操作関数

**期間**: 1日（実装完了）

---

### 5. 修正済みフラグのUI（✅ 実装済み）

**目的**: ユーザーが記事を「修正済み」とマークできるようにする

**実装内容**:
1. ✅ 修正済みフラグ設定UI
   - ✅ 記事詳細ページに「修正済みにする」ボタンを追加
   - ✅ 修正済みにした日時を記録
   - ✅ 修正済みバッジの表示
2. ✅ 修正済みフラグ更新API
   - ✅ `/api/articles/[id]/mark-as-fixed` エンドポイントを作成
   - ✅ `articles.is_fixed` と `articles.fixed_at` を更新
3. ✅ 修正済み記事の表示
   - ✅ ダッシュボードで修正済み記事を視覚的に区別（バッジ表示）
   - ✅ 修正済み記事は通知対象から除外（既に実装済み）

**成果物**:
- ✅ `app/api/articles/[id]/mark-as-fixed/route.ts` - 修正済みフラグ更新API
- ✅ 記事詳細ページにUI追加

**期間**: 1日（実装完了）

---

### 6. ユーザーのロケール設定（✅ 実装済み）

**目的**: 通知メールの言語をユーザー設定に合わせる

**実装内容**:
1. ✅ `users` テーブルに `locale` カラムを追加
   - ✅ マイグレーションファイルを作成（`supabase/migrations/006_add_user_locale.sql`）
   - ✅ デフォルト値: 'ja'
2. ✅ フロントエンドでロケールを保存
   - ✅ 設定画面（`/dashboard/settings`）でロケールを保存
   - ✅ `next-intl` のロケール設定をDBに保存
   - ✅ ロケール変更時にページをリロード
3. ✅ Cronジョブでユーザーのロケールを使用
   - ✅ `/api/cron/check-rank` でユーザーのロケールを取得
   - ✅ 通知メールの言語をユーザー設定に合わせる

**成果物**:
- ✅ `supabase/migrations/006_add_user_locale.sql` - ロケールカラム追加
- ✅ `lib/db/users.ts` - ロケール更新関数（`updateUserLocale`）
- ✅ `app/api/users/update-locale/route.ts` - ロケール更新API
- ✅ `app/api/users/me/route.ts` - ユーザー情報取得API
- ✅ `app/[locale]/dashboard/settings/page.tsx` - 設定画面
- ✅ Cronジョブのロケール取得処理

**期間**: 0.5日（実装完了）

---

### 7. 競合サイトのフィルタリング機能（Wikipedia・ECサイト等の除外）

**目的**: 分析対象から明らかに上位になるサイト（Wikipedia、大手ECサイト等）を除外し、より実用的な競合分析を行う

**実装内容**:
1. 除外対象サイトの定義
   - 除外リストの作成（Wikipedia、Amazon、楽天、Yahoo!ショッピング等）
   - ドメインベースまたはURLパターンベースの除外
   - ユーザー設定で除外リストをカスタマイズ可能にする（オプション）
2. 競合URL抽出時のフィルタリング
   - `lib/competitor-extractor.ts` に除外ロジックを追加
   - 除外対象サイトを検出してスキップ
3. 除外理由の記録
   - 除外されたサイトと理由をログに記録
   - 分析結果に除外情報を含める（オプション）

**成果物**:
- `lib/competitor-filter.ts` - 競合サイトフィルタリング関数
- 除外リストの設定ファイルまたはDBテーブル
- 競合URL抽出処理への統合

**期間**: 1-2日

**検討事項**:
- 除外が必要かどうか（WikipediaやECサイトも競合として分析すべき場合がある）
- 除外リストをユーザーがカスタマイズできるか
- 除外対象の自動検出（ドメイン権威性の判定など）

---

### 8. Slack通知機能

**目的**: メール通知に加えて、Slack通知も送信できるようにする

**実装内容**:
1. Slack Webhook連携
   - ユーザーがSlack Webhook URLを設定
   - `notification_settings` テーブルに `slack_webhook_url` カラムを追加
2. Slack通知送信機能
   - `lib/notification.ts` に `sendSlackNotification()` 関数を追加
   - Slack APIを使用して通知を送信
   - メール通知と同様の内容をSlack形式に変換
3. 通知設定UI
   - ダッシュボードの設定画面でSlack Webhook URLを入力
   - 通知方法（メール/Slack/両方）を選択

**成果物**:
- `lib/slack-notification.ts` - Slack通知送信関数
- `app/api/notifications/slack/route.ts` - Slack通知API（オプション）
- 通知設定UIの拡張

**期間**: 1-2日

**前提条件**:
- ユーザーがSlack Webhook URLを取得する必要がある

---

### 9. AI SEO対策（AIO対応）

**目的**: AI検索エンジン（AIO: AI Overview）に対応したSEO対策を提供

**実装内容**:
1. AI検索結果の分析
   - AI Overviewで表示される内容の分析
   - AIが引用する情報源の特定
   - AIが重視する要素の特定（構造化データ、FAQ、要約等）
2. AI検索最適化の提案
   - 構造化データ（JSON-LD）の追加提案
   - FAQセクションの追加提案
   - 要約・結論セクションの追加提案
   - AIが理解しやすいコンテンツ構造の提案
3. AI検索結果のモニタリング
   - 自社記事がAI Overviewに表示されているかチェック
   - AI検索結果での順位を追跡（可能な場合）

**成果物**:
- `lib/ai-seo-analyzer.ts` - AI SEO分析関数
- AI検索最適化の提案を分析結果に含める
- AI検索結果のモニタリング機能（オプション）

**期間**: 2-3日

**検討事項**:
- AI検索結果の取得方法（API、スクレイピング等）
- AI検索最適化の具体的な指標
- 既存の分析結果との統合方法

---

### 10. 課金動線の実装

**目的**: 有料プランへの誘導と決済機能を実装

**実装内容**:
1. プラン管理機能
   - プラン一覧の表示（無料、ベーシック、プロ等）
   - プラン比較表
   - 現在のプランと利用状況の表示
2. 決済機能
   - Stripe等の決済サービスとの連携
   - サブスクリプション管理
   - プラン変更機能
3. 使用制限の実装
   - プランごとの制限（分析回数、記事数等）
   - 制限に達した場合の警告とアップグレード誘導
4. 課金動線の最適化
   - 無料プランでの体験を提供
   - 適切なタイミングでのアップグレード誘導
   - 価格ページの作成

**成果物**:
- `app/[locale]/pricing/page.tsx` - 価格ページ
- `app/[locale]/dashboard/billing/page.tsx` - 課金管理ページ
- `app/api/billing/` - 決済関連API
- Stripe連携機能

**期間**: 3-5日

**前提条件**:
- Stripeアカウントの作成
- プラン設計の確定

---

## 実装フェーズ（将来）

### Phase 2: 手動スキャン機能（GSC連携不要）

- [ ] 1記事分析のロジック（ブラウジングツール + 自前クローラー + Gemini）
  - ブラウジングツール（Playwright、Puppeteer等）で競合URLを取得
  - ブラウジングツールで現在の順位を特定
  - キーワード入力またはAI推測
  - 自前クローラー（Beautiful Soup/cheerio等）で競合記事スクレイピング
  - CAPTCHA対応（リトライ機能、ユーザーエージェントローテーション等）
- [ ] 無料お試し画面（ログイン不要）
  - URL入力フォーム
  - 現在の順位表示
  - 改善案の一部表示
- [ ] デモモード（成功事例表示）

**期間**: 1-2週間

### Phase 3: 通知の多様化と設定（継続）

- [ ] LINE通知
- [ ] 通知頻度設定（優先度低）
  - 例：毎日、週1回まとめて、急落時のみなど
- [ ] **アラート設定のカスタマイズ機能**（将来機能）
  - 急落の判定条件をユーザーが設定可能
    - 平均順位の下落幅（デフォルト2位以上 → 1.5位、3位などに変更可能）
    - 特定キーワードの転落条件（デフォルト10位以下 → 5位、15位などに変更可能）
  - 過去何日間の平均順位かをユーザーが設定可能（デフォルト7日間 → 3日、14日、30日などに変更可能）
  - 設定画面で変更可能

**期間**: 1週間（通知の多様化）+ 追加1週間（アラート設定のカスタマイズ）

**注意**: 
- 通知頻度設定は必要だが、優先度は低い（デフォルト設定で開始）
- アラート設定のカスタマイズは将来機能

### Phase 4: 有料プラン機能（継続）

- [ ] プラン管理（上記「9. 課金動線の実装」で実装）
- [ ] 使用回数の制限（上記「9. 課金動線の実装」で実装）
- [ ] 決済機能（Stripe等）（上記「9. 課金動線の実装」で実装）

**期間**: 3-5日（上記「9. 課金動線の実装」に統合）

### Phase 5: 追加機能（将来）

- [ ] WordPress連携（WordPressユーザーではない人もいるため、後回し）
  - リライト案をワンクリックでWPに反映
  - 料金: +月額1,000円

**期間**: 未定（需要を確認してから実装）

---

## 技術的な考慮事項

### エラーハンドリング

- API制限に達した場合の対応
- 競合サイトが取得できない場合の対応
- GSCデータが取得できない場合の対応

### パフォーマンス

- 分析の実行時間を30秒以内に
- キャッシュの活用でコスト削減
- 同時実行数の制限

### セキュリティ

- GSCデータの暗号化
- APIキーの安全な管理
- ユーザーデータの保護
