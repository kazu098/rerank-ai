# 記事生成自動化の改善案

## 現状の課題

現在のサービスでは、以下の手順で記事改善を行っています：

1. 順位下落を検知（`/api/cron/check-rank`）
2. ユーザーに通知を送信（`/api/cron/send-notifications`）
3. **ユーザーが手動で記事改善案を生成**（`/api/article-improvement/generate`）
4. **ユーザーが改善案をコピーして記事に適用**

**問題点**：
- 毎回記事生成を依頼して修正記事をペーストする手間がある
- ユーザーが改善案を確認・適用するまで時間がかかる
- 改善案の生成がユーザーのアクションに依存している

## 改善案：AIエージェントとしての完全自動化

### アプローチ1: 順位下落検知時に自動で改善案を生成（推奨）

#### 概要
順位下落を検知したタイミングで、自動的に記事改善案を生成し、データベースに保存する。

#### 実装フロー

```
1. 順位下落検知（既存の /api/cron/check-rank）
   ↓
2. 新規: 改善案自動生成ジョブをキューに追加
   ↓
3. 新規: 改善案生成cron（/api/cron/generate-improvements）
   - 分析結果を取得
   - 記事をスクレイピング
   - Gemini APIで改善案を生成
   - article_improvementsテーブルに保存
   ↓
4. 通知送信時に改善案へのリンクを含める（既存の /api/cron/send-notifications）
   ↓
5. ユーザーがダッシュボードで改善案を確認・適用
```

#### メリット
- ✅ ユーザーの手間が大幅に削減される
- ✅ 順位下落検知から改善案生成まで自動化
- ✅ 改善案がすぐに利用可能になる
- ✅ ユーザーは確認・承認するだけ

#### デメリット
- ⚠️ コストが発生（1記事あたり約0.3円）
- ⚠️ 改善案の品質が不十分な場合もある
- ⚠️ ユーザーが改善案を確認しない可能性

#### 実装が必要なもの

1. **データベーススキーマ**
   - `article_improvements`テーブルを作成
   - 改善案データ、ステータス、生成日時などを保存

2. **改善案生成cron job**
   - `/api/cron/generate-improvements`
   - 順位下落検知された記事に対して改善案を生成
   - 既存の`ArticleImprovementGenerator`を利用

3. **通知の拡張**
   - 通知メール/Slackに改善案へのリンクを追加
   - 「改善案が生成されました」という通知

4. **UIの拡張**
   - ダッシュボードに改善案一覧を表示
   - 改善案のプレビュー・承認機能

---

### アプローチ2: 分析結果保存時に自動で改善案を生成

#### 概要
競合分析が完了して分析結果が保存されたタイミングで、自動的に改善案を生成する。

#### 実装フロー

```
1. 競合分析実行（既存の /api/analysis/save）
   ↓
2. 分析結果を保存（既存の処理）
   ↓
3. 新規: 分析結果保存後に改善案生成をトリガー
   - バックグラウンドジョブとして実行
   - または、分析結果保存API内で同期的に実行
   ↓
4. 改善案をarticle_improvementsテーブルに保存
   ↓
5. ユーザーが分析結果画面で改善案を確認
```

#### メリット
- ✅ 分析結果と同時に改善案が利用可能
- ✅ ユーザーが分析結果を確認するタイミングで改善案も見られる
- ✅ 実装が比較的シンプル

#### デメリット
- ⚠️ 分析実行のたびにコストが発生
- ⚠️ 順位下落していない記事にも改善案を生成してしまう可能性

---

### アプローチ3: ユーザー設定に基づく自動生成

#### 概要
ユーザーが設定で「自動改善案生成」を有効にした場合のみ、自動生成を実行する。

#### 実装フロー

```
1. ユーザー設定に「auto_generate_improvements」フラグを追加
   ↓
2. 順位下落検知時、または分析結果保存時に設定をチェック
   ↓
3. 設定が有効な場合のみ改善案を自動生成
   ↓
4. 改善案を保存・通知
```

#### メリット
- ✅ ユーザーが自動生成を選択できる
- ✅ コストを制御できる
- ✅ 段階的な導入が可能

#### デメリット
- ⚠️ ユーザーが設定を有効にしないと機能しない

---

## 推奨実装方針

### Phase 1: 順位下落検知時の自動改善案生成（アプローチ1）

**理由**：
- 順位下落が検知された記事は改善の優先度が高い
- 既存の通知システムと統合しやすい
- ユーザーの手間を最も削減できる

**実装内容**：

1. **データベーススキーマ**
   ```sql
   CREATE TABLE article_improvements (
     id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
     article_id UUID NOT NULL REFERENCES articles(id) ON DELETE CASCADE,
     analysis_result_id UUID REFERENCES analysis_results(id) ON DELETE SET NULL,
     improvement_data JSONB NOT NULL, -- ArticleImprovementResult形式
     status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'reviewed', 'applied', 'rejected')),
     created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
     updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
     reviewed_at TIMESTAMP WITH TIME ZONE,
     applied_at TIMESTAMP WITH TIME ZONE
   );
   ```

2. **改善案生成cron job**
   - `/api/cron/generate-improvements`
   - 順位下落検知された記事（通知が作成された記事）を対象
   - 最新の分析結果を取得
   - 改善案を生成して保存
   - エラーハンドリングとリトライ機能

3. **通知の拡張**
   - 通知メール/Slackに「改善案を確認する」リンクを追加
   - 改善案が生成されたことを明示

4. **UIの拡張**
   - 記事詳細ページに「改善案」タブを追加
   - 改善案一覧ページを作成
   - 改善案のプレビュー・承認機能

### Phase 2: ユーザー設定による制御（アプローチ3の統合）

**実装内容**：
- ユーザー設定に`auto_generate_improvements`フラグを追加
- デフォルトは`false`（手動生成のみ）
- ユーザーが有効化した場合のみ自動生成を実行

### Phase 3: 改善案の自動適用（オプション）

**実装内容**：
- ユーザーが「自動適用」を有効にした場合
- 改善案の品質スコアが一定以上の場合のみ自動適用
- WordPress/Git連携など、プラットフォーム対応

---

## 技術的な考慮事項

### 1. コスト管理

**現状のコスト**：
- 1記事あたり約0.3円（Gemini 2.0 Flash Lite使用時）

**対策**：
- ユーザーごとの1日あたりの生成回数制限
- 有料プランのみ自動生成を有効化
- または、無料ユーザーは1日5回まで、有料ユーザーは無制限

### 2. エラーハンドリング

**考慮事項**：
- 記事のスクレイピング失敗
- Gemini APIのレート制限
- 分析結果が存在しない場合

**実装**：
- リトライ機能（最大3回）
- エラーログの記録
- ユーザーへのエラー通知

### 3. パフォーマンス

**考慮事項**：
- 改善案生成は時間がかかる（10-30秒）
- 大量の記事を同時に処理すると負荷が高い

**実装**：
- 非同期処理（キューシステム）
- 時間分散処理（既存のスロットシステムを活用）
- レート制限の実装

### 4. 改善案の品質

**考慮事項**：
- 自動生成された改善案の品質が不十分な場合がある
- ユーザーが確認・編集できる必要がある

**実装**：
- 改善案に品質スコアを付与（将来的に）
- ユーザーが改善案を編集できる機能
- 改善案の履歴管理

---

## 実装の優先順位

### 最優先（MVP）
1. ✅ データベーススキーマの作成
2. ✅ 改善案生成cron jobの実装
3. ✅ 通知への改善案リンク追加
4. ✅ ダッシュボードでの改善案表示

### 次優先
5. ユーザー設定による制御
6. エラーハンドリングの強化
7. 改善案の品質評価機能

### 将来の拡張
8. 改善案の自動適用
9. プラットフォーム連携（WordPress/Git）
10. 改善案のA/Bテスト機能

---

## 既存システムとの統合

### 既存のcron jobとの連携

**`/api/cron/check-rank`**：
- 順位下落検知時に、改善案生成ジョブをキューに追加
- または、`article_improvements`テーブルに`pending`ステータスでレコードを作成

**`/api/cron/send-notifications`**：
- 通知送信時に、改善案が存在するかチェック
- 存在する場合は、通知に改善案へのリンクを追加

### 既存のAPIとの連携

**`/api/article-improvement/generate`**：
- 既存のAPIは手動生成用として残す
- 自動生成も同じ`ArticleImprovementGenerator`クラスを使用

**`/api/analysis/save`**：
- 分析結果保存時に、改善案生成をトリガーするオプションを追加（Phase 2以降）

---

## ユーザー体験の改善

### 現在のフロー
```
順位下落検知 → 通知受信 → 手動で改善案生成 → コピー&ペースト
```

### 改善後のフロー
```
順位下落検知 → 自動で改善案生成 → 通知受信（改善案リンク付き） → 確認・適用
```

**メリット**：
- ユーザーの手間が大幅に削減
- 改善案がすぐに利用可能
- より迅速な対応が可能

---

## まとめ

記事生成の自動化により、以下の改善が期待できます：

1. **ユーザーの手間削減**: 手動での改善案生成が不要
2. **迅速な対応**: 順位下落検知から改善案生成まで自動化
3. **ユーザー体験の向上**: 通知と同時に改善案が利用可能

**推奨実装順序**：
1. Phase 1: 順位下落検知時の自動改善案生成（MVP）
2. Phase 2: ユーザー設定による制御
3. Phase 3: 改善案の自動適用（オプション）

**コスト**: 1記事あたり約0.3円（非常に低コスト）

**リスク**: 
- 改善案の品質が不十分な場合がある → ユーザーが確認・編集できる機能が必要
- コストが累積する → ユーザーごとの制限を設ける
