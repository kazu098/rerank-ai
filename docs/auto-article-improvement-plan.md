# 記事自動改善機能 実装方針

## 概要

分析結果を元に、記事の修正まで自動で行う機能の実装方針を記載します。

## 背景

現在、分析結果として以下が提供されています：
- なぜ競合が上位なのか
- 追加すべき項目（理由、内容、参考URL）

これらの情報を元に、実際の記事修正まで自動で行うことで、ユーザーの作業負荷を大幅に削減できます。

## 課題と制約

### 1. LLMコスト
- 記事修正にはLLM（GPT-4等）を使用する必要がある
- コストがかかるため、ユーザーにAPI keyを入力させて実行する方針

### 2. プラットフォームの多様性
- WordPress
- 自社サイト（CMS、静的サイトなど）
- Gitリポジトリ（PR作成）
- その他

### 3. 修正内容の種類
- **新規項目の追加**: 新しいセクションとして追加（比較的容易）
- **既存内容の改善**: 既存セクションを拡張・修正（難易度が高い）
- **構造の変更**: 記事全体の構造を変更（最も難しい）

## 実装方針

### Phase 1: 修正案の生成とプレビュー（MVP）

**目的**: ユーザーが修正案を確認してから適用できるようにする

**機能**:
1. 分析結果から「追加すべき項目」を抽出
2. ユーザーがOpenAI API keyを入力（初回のみ、セキュアに保存）
3. LLMを使用して修正案を生成
4. プレビューを表示（差分表示）
5. ユーザーが承認後に適用

**実装内容**:
- API key管理機能（暗号化して保存）
- 修正案生成API（`/api/article-improvement/generate`）
- プレビューUI（差分表示）
- 承認・適用機能

**技術スタック**:
- OpenAI API（GPT-4 Turbo推奨）
- 記事のHTML/Markdown解析（cheerio、remark等）

### Phase 2: 基本的な記事修正機能

**目的**: 実際の記事を修正できるようにする

**機能**:
1. 記事の取得方法
   - URLから記事を取得（スクレイピング）
   - または、ユーザーが記事内容をコピペ
2. 修正案の適用
   - 新規セクションの追加（指定位置に挿入）
   - 既存セクションの拡張（慎重に実装）
3. 修正後の記事を表示・ダウンロード

**実装内容**:
- 記事取得機能
- 修正案適用ロジック
- 修正後の記事エクスポート機能

### Phase 3: プラットフォーム対応

**目的**: 各種プラットフォームに対応

#### 3.1 WordPress対応

**機能**:
- WordPress REST APIを使用して記事を取得・更新
- ユーザーがWordPressの認証情報を入力
- 修正案をWordPressに直接適用

**実装内容**:
- WordPress認証情報管理
- WordPress API連携
- 記事の取得・更新機能

#### 3.2 Git対応

**機能**:
- GitリポジトリにPRを作成
- 修正案をコミットしてPRとして提出
- ユーザーがGitHub/GitLabの認証情報を入力

**実装内容**:
- Git認証情報管理（Personal Access Token等）
- Git操作（clone、commit、push、PR作成）
- PR作成機能

#### 3.3 自社サイト対応

**機能**:
- 記事のHTML/Markdownを取得
- 修正案を適用
- 修正後のファイルをダウンロード

**実装内容**:
- 記事取得機能（スクレイピング、API連携等）
- 修正案適用機能
- ファイルエクスポート機能

## 実装の優先順位

1. **Phase 1（修正案の生成とプレビュー）**: 最優先
   - ユーザーが修正案を確認できる
   - コストを最小限に抑えられる
   - 実装が比較的容易

2. **Phase 2（基本的な記事修正機能）**: 次優先
   - 実際の記事修正が可能になる
   - 新規セクションの追加から実装

3. **Phase 3（プラットフォーム対応）**: 段階的に実装
   - ユーザーの要望に応じて優先順位を決定
   - WordPress → Git → 自社サイトの順で実装

## 技術的な考慮事項

### 1. API key管理

**セキュリティ**:
- API keyは暗号化して保存（AES-256等）
- データベースに保存する場合は、環境変数で暗号化キーを管理
- または、ブラウザのlocalStorageに保存（クライアント側のみ）

**実装案**:
```typescript
// 暗号化して保存
const encryptedApiKey = encrypt(apiKey, encryptionKey);
// 復号化して使用
const apiKey = decrypt(encryptedApiKey, encryptionKey);
```

### 2. 修正案生成のプロンプト設計

**重要なポイント**:
- 既存記事の構造を維持
- 自然な文章の流れを保つ
- 適切な位置に挿入
- 既存のスタイルに合わせる

**プロンプト例**:
```
あなたはSEO記事の改善専門家です。
以下の記事に対して、分析結果に基づいて改善案を生成してください。

【既存記事】
{existingArticle}

【追加すべき項目】
{improvementItems}

【要件】
1. 既存記事の構造とスタイルを維持する
2. 自然な文章の流れを保つ
3. 適切な位置に新しいセクションを追加する
4. 既存の内容を損なわないようにする

【出力形式】
修正後の記事全体をMarkdown形式で出力してください。
```

### 3. 記事の構造解析

**必要な機能**:
- HTML/Markdownの解析
- セクションの識別
- 挿入位置の決定

**実装案**:
- Markdown: `remark`、`markdown-it`等
- HTML: `cheerio`、`jsdom`等

### 4. エラーハンドリング

**考慮事項**:
- API keyの無効性
- 記事の取得失敗
- LLM APIのレート制限
- 修正案の適用失敗

**実装**:
- 適切なエラーメッセージを表示
- リトライ機能
- フォールバック処理

## UI/UX設計

### 1. 修正案生成画面

```
[分析結果表示]
- なぜ競合が上位なのか
- 追加すべき項目（3個）

[API key入力]
- OpenAI API key: [入力欄]
- 保存する（チェックボックス）

[修正案生成ボタン]
- 「修正案を生成する」ボタン

[修正案プレビュー]
- 差分表示（追加部分をハイライト）
- 承認/拒否ボタン
```

### 2. 修正案適用画面

```
[修正案プレビュー]
- 修正前/修正後の比較表示

[適用方法選択]
- [ ] 修正後の記事をダウンロード
- [ ] WordPressに適用
- [ ] Git PRを作成
- [ ] その他（カスタム）

[適用ボタン]
```

## コスト試算

### 1記事あたりのコスト（目安）

- **記事取得**: 無料（スクレイピング）
- **修正案生成**: GPT-4 Turbo使用時
  - 入力: 約5,000トークン（既存記事 + 分析結果）
  - 出力: 約3,000トークン（修正後の記事）
  - コスト: 約$0.05-0.10（記事の長さによる）

### ユーザーへの案内

- API keyはユーザーが管理
- 使用量はOpenAIのダッシュボードで確認可能
- コストはユーザー負担

## 今後の拡張可能性

1. **複数記事の一括改善**
   - 複数の記事を一度に改善

2. **改善履歴の管理**
   - 過去の改善履歴を保存
   - 改善前後の比較

3. **A/Bテスト機能**
   - 複数の改善案を生成
   - 効果を測定

4. **自動適用機能**
   - 一定の条件を満たす場合、自動で適用

## 実装スケジュール（目安）

- **Phase 1**: 2-3週間
- **Phase 2**: 1-2週間
- **Phase 3**: プラットフォームごとに1-2週間

## 参考資料

- [OpenAI API Documentation](https://platform.openai.com/docs)
- [WordPress REST API Handbook](https://developer.wordpress.org/rest-api/)
- [GitHub API Documentation](https://docs.github.com/en/rest)

